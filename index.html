<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMO CHAT</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap');

:root {
    --primary: #4a6fa5;
    --primary-dark: #3a5a80;
    --dark: #121212;
    --light: #f0f0f0;
    --error: #e74c3c;
    --whatsapp: #25D366;
    --message-sent: rgba(74, 111, 165, 0.25);
    --message-received: rgba(30, 30, 30, 0.8);
    --input-bg: rgba(240, 240, 240, 0.1);
    --light-bg: #ffffff;
    --light-text: #333333;
    --light-input-bg: rgba(0, 0, 0, 0.05);
    --message-bg-1: #2A3F5F;
    --message-bg-2: #1A3C34;
    --message-bg-3: #3B2F5B;
    --message-bg-4: #333333;
    --message-bg-5: #4A1C2A;
    --message-text-1: #E0E0E0;
    --message-text-2: #F4D03F;
    --message-text-3: #AED6F1;
    --message-text-4: #F5B7B1;
    --message-text-5: #A9DFBF;
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--dark);
            color: var(--light);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.light-mode {
            background: var(--light-bg);
            color: var(--light-text);
        }

        body.light-mode .login,
        body.light-mode .chat-container,
        body.light-mode .modal-content,
        body.light-mode .chat-header,
        body.light-mode .message-input-container,
        body.light-mode .message.received,
        body.light-mode .search-container {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--primary);
        }

        body.light-mode .form-input,
        body.light-mode .message-input,
        body.light-mode .search-input {
            background: var(--light-input-bg);
            color: var(--light-text);
        }

        .page {
            display: none;
            flex: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .page.active {
            display: flex;
            opacity: 1;
        }

        .login {
            width: 100%;
            max-width: 450px;
            margin: 0 25px;
            background: rgba(18, 18, 18, 0.9);
            padding: 2rem;
            border-radius: 15px;
            border: 1px solid var(--primary);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .title {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--primary);
            font-size: 2.3rem;
            animation: pulseTitle 2s infinite;
        }

        @keyframes pulseTitle {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .form-group {
            margin-bottom: 2rem;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--light);
        }

        body.light-mode .form-label {
            color: var(--light-text);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            background: var(--input-bg);
            border: none;
            border-radius: 8px;
            color: var(--light);
            font-size: 1rem;
            border-bottom: 2px solid var(--primary);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .form-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(74, 111, 165, 0.3);
        }

        .password-container {
            position: relative;
        }

        .toggle-password {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: rgba(255, 255, 255, 0.5);
        }

        body.light-mode .toggle-password {
            color: rgba(0, 0, 0, 0.5);
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 1rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .terms-link {
            color: var(--primary);
            text-decoration: none;
            cursor: pointer;
            display: inline-block;
            margin-top: 1.5rem;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
        }

        .terms-link:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }

        .terms-checkbox {
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .terms-checkbox input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .terms-checkbox input[type="checkbox"]:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .terms-checkbox input[type="checkbox"]:checked::after {
            content: "✓";
            position: absolute;
            color: white;
            font-size: 14px;
            font-weight: bold;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .terms-checkbox input[type="checkbox"]:hover {
            border-color: var(--primary-dark);
            box-shadow: 0 0 5px rgba(74, 111, 165, 0.5);
        }

        .terms-checkbox label {
            font-size: 16px;
            cursor: pointer;
            transition: color 0.3s ease;
            color: #999;
            margin-top: 8px;
        }

        body.light-mode .terms-checkbox label {
            color: var(--light-text);
        }

        .terms-checkbox input[type="checkbox"]:checked + label {
            color: var(--primary);
        }

        .terms-checkbox:hover label {
            color: var(--primary);
        }

        .error-message {
            color: var(--error);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: none;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 1rem;
            background: rgba(18, 18, 18, 0.9);
            border-bottom: 1px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .chat-title {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .settings-btn, .theme-toggle {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.3rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .settings-btn:hover, .theme-toggle:hover {
            transform: rotate(360deg);
        }

        body.light-mode .settings-btn, body.light-mode .theme-toggle {
            color: var(--light-text);
        }

        .profile-image-container {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            border: 2px solid var(--primary);
        }

        .profile-image-icon {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-indicator {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--primary);
            width: 18px;
            height: 18px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
        }

        .profile-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            scroll-behavior: smooth;
        }

        .message {
            padding: 12px 15px;
            margin-bottom: 12px;
            border-radius: 12px;
            position: relative;
            animation: slideIn 0.3s ease-out;
            word-break: break-word;
            max-width: 80%;
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .sent {
            background: var(--message-sent);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .received {
            background: var(--message-received);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .message-user {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .message-user-img {
            width: 35px;
            height: 35px;
            border-radius: 6px;
            margin-right: 8px;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .message-user-name {
            font-weight: bold;
            font-size: 0.95rem;
            color: var(--primary);
        }

        .message-text {
            margin: 8px 0;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            text-align: left;
        }

        .message-image {
            max-width: 100%;
            max-height: 250px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
            object-fit: contain;
        }

        .message-audio {
            width: 100%;
            margin-top: 8px;
        }

        .message-actions {
            position: absolute;
            top: 5px;
            left: 5px;
            display: none;
        }

        .message:hover .message-actions {
            display: block;
        }

        .delete-message-btn {
            background: var(--error);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .delete-message-btn:hover {
            background: #c0392b;
        }

        .message-input-container {
            display: flex;
            gap: 8px;
            padding: 1rem;
            background: rgba(18, 18, 18, 0.9);
            border-top: 1px solid var(--primary);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border-radius: 8px;
            border: none;
            background: var(--input-bg);
            color: var(--light);
            resize: none;
            max-height: 120px;
            min-height: 50px;
            transition: transform 0.3s ease;
        }

        .message-input:focus {
            transform: translateY(-2px);
        }

        .send-btn, .image-btn, .audio-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .send-btn:hover, .image-btn:hover, .audio-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .send-btn:active {
            animation: pulse 0.2s ease;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .image-preview-container {
            display: none;
            margin: 10px;
            position: relative;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
        }

        .remove-image-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--error);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: rgba(18, 18, 18, 0.9);
            padding: 2rem;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            border: 1px solid var(--primary);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: popUp 0.3s ease;
        }

        @keyframes popUp {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-title {
            color: var(--primary);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--primary);
            color: var(--light);
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            transition: transform 0.3s ease;
        }

        .close-modal:hover {
            transform: rotate(90deg);
        }

        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .profile-image {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            border: 3px solid var(--primary);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .profile-image:hover {
            transform: scale(1.05);
        }

        .profile-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .profile-status {
            color: var(--primary);
            background: rgba(74, 111, 165, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .profile-form {
            margin-top: 1.5rem;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 1.5rem;
        }

        .profile-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        body.light-mode .profile-btn.cancel {
            background: rgba(0, 0, 0, 0.1);
            color: var(--light-text);
        }

        .profile-btn.save {
            background: var(--primary);
            color: white;
        }

        .settings-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 1.5rem;
        }

        .settings-option {
            padding: 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body.light-mode .settings-option {
            background: rgba(0, 0, 0, 0.05);
        }

        .settings-option:hover {
            background: rgba(74, 111, 165, 0.1);
            transform: translateX(5px);
        }

        .settings-option i {
            font-size: 1.2rem;
            color: var(--primary);
        }

        .notification-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 1rem;
        }

        .notification-toggle input {
            appearance: none;
            width: 40px;
            height: 20px;
            background: var(--input-bg);
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            outline: none;
        }

        body.light-mode .notification-toggle input {
            background: var(--light-input-bg);
        }

        .notification-toggle input::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--light);
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        body.light-mode .notification-toggle input::before {
            background: var(--light-text);
        }

        .notification-toggle input:checked {
            background: var(--primary);
        }

        .notification-toggle input:checked::before {
            left: 22px;
        }

        .notification-tone {
            margin-top: 1rem;
        }

        .notification-tone select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--light);
            border: none;
            border-bottom: 2px solid var(--primary);
        }

        body.light-mode .notification-tone select {
            background: var(--light-input-bg);
            color: var(--light-text);
        }

        .search-container {
            padding: 1rem;
            background: rgba(18, 18, 18, 0.9);
            border-bottom: 1px solid var(--primary);
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: none;
            background: var(--input-bg);
            color: var(--light);
            font-size: 1rem;
            transition: transform 0.3s ease;
        }

        .search-input:focus {
            transform: translateY(-2px);
        }

        .typing-indicator {
            padding: 10px;
            font-size: 0.9rem;
            color: var(--primary);
            display: none;
        }

        .recording-indicator {
            display: none;
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .audio-btn.recording {
            background: var(--error);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            display: flex;
            opacity: 1;
        }

        .loading-spinner {
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 5px solid var(--primary);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            animation: popToast 0.3s ease-out;
            z-index: 1001;
        }

        .toast.error {
            background: var(--error);
        }

        @keyframes popToast {
            0% { transform: translateX(-50%) scale(0.8); opacity: 0; }
            50% { transform: translateX(-50%) scale(1.1); }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .login {
                padding: 1.5rem;
            }
            .title {
                font-size: 2rem;
            }
            .message {
                max-width: 90%;
            }
            .modal-content {
                padding: 1.5rem;
            }
            .send-btn, .image-btn, .audio-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
        }
        @media (max-width: 768px) {
    .login {
        padding: 1rem;
        margin: 10px;
    }
    .title {
        font-size: 1.8rem;
    }
    .message {
        max-width: 95%;
        padding: 10px;
    }
    .modal-content {
        padding: 1rem;
        max-width: 90%;
    }
    .send-btn, .image-btn, .audio-btn {
        width: 40px;
        height: 40px;
        font-size: 0.9rem;
    }
    .message-input-container {
        gap: 5px;
    }
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
@-webkit-keyframes spin {
    0% { -webkit-transform: rotate(0deg); }
    100% { -webkit-transform: rotate(360deg); }
}
@-moz-keyframes spin {
    0% { -moz-transform: rotate(0deg); }
    100% { -moz-transform: rotate(360deg); }
}
.modal {
    z-index: 1000;
}
.loading-overlay {
    z-index: 2000;
}
.toast {
    z-index: 1001;
}
@media (max-width: 768px) {
    .login {
        padding: 1rem;
        margin: 10px;
    }
    .title {
        font-size: 1.8rem;
    }
    .message {
        max-width: 95%;
        padding: 10px;
    }
    .modal-content {
        padding: 1rem;
        max-width: 90%;
    }
    .send-btn, .image-btn, .audio-btn {
        width: 40px;
        height: 40px;
        font-size: 0.9rem;
    }
    .message-input-container {
        gap: 5px;
    }
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
@-webkit-keyframes spin {
    0% { -webkit-transform: rotate(0deg); }
    100% { -webkit-transform: rotate(360deg); }
}
@-moz-keyframes spin {
    0% { -moz-transform: rotate(0deg); }
    100% { -moz-transform: rotate(360deg); }
}

.sent[data-user-id] {
    background: var(--message-bg, var(--message-sent)) !important;
    color: var(--message-text, var(--light)) !important;
}

.sent[data-user-id] .message-text,
.sent[data-user-id] .message-user-name,
.sent[data-user-id] .message-time {
    color: inherit !important;
}

.profile-image-icon,
#settingsProfileImage,
#profileImagePreview {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    object-fit: cover;
    display: block;
}

.profile-loading {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 24px;
    height: 24px;
    border: 3px solid var(--light);
    border-top: 3px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- صفحة تسجيل الدخول -->
    <div class="page" id="loginPage">
        <div class="login">
            <h1 class="title">SMO CHAT</h1>
            <div class="form-group">
                <label for="loginUsername" class="form-label">اسم المستخدم</label>
                <input type="text" id="loginUsername" class="form-input" placeholder="ادخل اسم المستخدم" autocomplete="off">
                <div id="usernameError" class="error-message">اسم المستخدم مطلوب</div>
            </div>
            <div class="form-group">
                <label for="loginPassword" class="form-label">كلمة السر</label>
                <div class="password-container">
                    <input type="password" id="loginPassword" class="form-input" placeholder="ادخل كلمة السر" autocomplete="off">
                    <i class="fas fa-eye toggle-password" onclick="togglePassword('loginPassword')"></i>
                </div>
                <div id="passwordError" class="error-message">كلمة السر مطلوبة</div>
            </div>
            <div class="terms-checkbox">
                <input type="checkbox" id="agreeTerms" name="agreeTerms">
                <label for="agreeTerms">أوافق على الشروط والأحكام</label>
            </div>
            <div id="termsError" class="error-message">يجب الموافقة على الشروط والأحكام</div>
            <button class="btn" onclick="login()">تسجيل الدخول</button>
            <a class="terms-link" onclick="showModal('registerModal')">إنشاء حساب جديد</a>
            <a class="terms-link" onclick="showModal('termsModal')">عرض الشروط والأحكام</a>
        </div>
    </div>

    <!-- صفحة الدردشة -->
    <div class="page" id="chatPage">
        <div class="chat-container">
            <div class="chat-header">
<div class="profile-image-container" onclick="showModal('profileModal')">
    <img id="currentProfileImage" src="https://f.top4top.io/p_3410530mv1.jpg" class="profile-image-icon">
    <div class="upload-indicator">
        <i class="fas fa-camera"></i>
    </div>
    <div class="profile-loading" id="profileLoading"></div>
</div>
    <div class="chat-title">SMO CHAT</div>
    <button class="settings-btn" onclick="showModal('settingsModal')">
        <i class="fas fa-cog"></i>
    </button>
</div>
            <!--<div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="ابحث في الرسائل..." oninput="searchMessages()">
            </div>--> 
            <div class="typing-indicator" id="typingIndicator"></div>
            <div class="messages-container" id="messagesContainer"></div>
            <div class="image-preview-container" id="imagePreviewContainer">
                <button class="remove-image-btn" onclick="removeImagePreview()">
                    <i class="fas fa-times"></i>
                </button>
                <img id="imagePreview" class="image-preview">
            </div>
            <div class="message-input-container">
                <button class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <textarea class="message-input" id="messageInput" placeholder="اكتب رسالتك..." rows="1"></textarea>
                <button class="image-btn" onclick="document.getElementById('messageImage').click()">
                    <i class="fas fa-image"></i>
                </button>
                <button class="audio-btn" id="audioBtn" onclick="toggleRecording()">
                    <i class="fas fa-microphone"></i>
                    <span class="recording-indicator" id="recordingIndicator">تسجيل...</span>
                </button>
                <input type="file" id="messageImage" accept="image/*" style="display: none;" onchange="handleImageUpload()">
            </div>
            <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImageUpload(this.files[0])">
        </div>
    </div>

    <!-- نافذة إنشاء حساب -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <button class="close-modal" onclick="hideModal('registerModal')">×</button>
            <h2 class="modal-title">إنشاء حساب جديد</h2>
            <div class="form-group">
                <label for="regUsername" class="form-label">اسم المستخدم</label>
                <input type="text" id="regUsername" class="form-input" placeholder="ادخل اسم المستخدم (3-20 حرف)" autocomplete="off">
                <div id="regUsernameError" class="error-message">اسم المستخدم مطلوب</div>
            </div>
            <div class="form-group">
                <label for="regPassword" class="form-label">كلمة السر</label>
                <div class="password-container">
                    <input type="password" id="regPassword" class="form-input" placeholder="ادخل كلمة السر (6 أحرف على الأقل)" autocomplete="new-password">
                    <i class="fas fa-eye toggle-password" onclick="togglePassword('regPassword')"></i>
                </div>
                <div id="regPasswordError" class="error-message">كلمة السر مطلوبة</div>
            </div>
            <div class="form-group">
                <label for="regConfirmPassword" class="form-label">تأكيد كلمة السر</label>
                <div class="password-container">
                    <input type="password" id="regConfirmPassword" class="form-input" placeholder="أعد إدخال كلمة السر" autocomplete="new-password">
                    <i class="fas fa-eye toggle-password" onclick="togglePassword('regConfirmPassword')"></i>
                </div>
                <div id="regConfirmPasswordError" class="error-message">تأكيد كلمة السر مطلوب</div>
            </div>
            <button class="btn" onclick="register()">إنشاء حساب</button>
        </div>
    </div>

    <!-- نافذة الشروط والأحكام -->
    <div class="modal" id="termsModal">
        <div class="modal-content">
            <button class="close-modal" onclick="hideModal('termsModal')">×</button>
            <h2 class="modal-title">الشروط والأحكام</h2>
            <div class="modal-text">
                <p>1. يحظر استخدام التطبيق لأغراض غير قانونية أو غير أخلاقية.</p>
                <p>2. يجب الحفاظ على سرية معلومات الحساب وعدم مشاركتها مع الآخرين.</p>
                <p>3. نحتفظ بالحق في تعليق أو حذف أي حساب ينتهك الشروط والأحكام.</p>
                <p>4. يجب ألا تحتوي المحادثات على محتوى مسيء أو غير لائق.</p>
                <p>5. يحظر استخدام التطبيق لإرسال رسائل غير مرغوب فيها أو بريد عشوائي.</p>
                <p>6. نحتفظ بالحق في تعديل الشروط والأحكام في أي وقت.</p>
                <p>7. أي انتهاك للشروط قد يؤدي إلى إنهاء حسابك فورًا.</p>
                <p>8. يجب أن تكون فوق 13 سنة لاستخدام هذا التطبيق.</p>
                <p>9. أنت مسؤول عن جميع الأنشطة التي تتم عبر حسابك.</p>
                <p>10. لا نتحمل مسؤولية أي خسائر ناتجة عن استخدام التطبيق.</p>
            </div>
        </div>
    </div>

    <!-- نافذة الإعدادات -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <button class="close-modal" onclick="hideModal('settingsModal')">×</button>
            <h2 class="modal-title">إعدادات الحساب</h2>
            <div class="profile-header">
                <img id="settingsProfileImage" src="" class="profile-image">
                <div class="profile-name" id="settingsUsername"></div>
                <div class="profile-status" id="settingsStatus"></div>
            </div>
            <div class="settings-options">
                <div class="settings-option" onclick="showModal('profileModal')">
                    <i class="fas fa-user-edit"></i>
                    <span>تعديل الملف الشخصي</span>
                </div>
                <div class="settings-option" onclick="showModal('passwordModal')">
                    <i class="fas fa-key"></i>
                    <span>تغيير كلمة السر</span>
                </div>
                <div class="settings-option" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>تسجيل الخروج</span>
                </div>
            </div>
            <div class="notification-toggle">
                <input type="checkbox" id="notificationsToggle" onchange="toggleNotifications()">
                <label for="notificationsToggle">تفعيل الإشعارات</label>
            </div>
            <div class="notification-tone">
                <label for="notificationTone" class="form-label">نغمة الإشعار</label>
                <select id="notificationTone" onchange="changeNotificationTone()">
                    <option value="default">افتراضي</option>
                    <option value="beep">بيب</option>
                    <option value="ding">دينغ</option>
                </select>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل الملف الشخصي -->
    <div class="modal" id="profileModal">
    <div class="modal-content">
        <button class="close-modal" onclick="hideModal('profileModal')">×</button>
        <h2 class="modal-title">تعديل الملف الشخصي</h2>
        <div class="profile-form">
            <div class="form-group">
                <label for="profileImageInput" class="form-label">صورة الملف الشخصي</label>
                <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleProfileImageUpload(this.files[0])">
                <button class="btn" onclick="document.getElementById('profileImageInput').click()">اختر صورة</button>
                <img id="profileImagePreview" src="https://f.top4top.io/p_3410530mv1.jpg" style="width: 100px; height: 100px; border-radius: 8px; margin-top: 10px; display: block;">
            </div>
            <div class="form-group">
                <label for="profileUsername" class="form-label">اسم المستخدم</label>
                <input type="text" id="profileUsername" class="form-input" placeholder="اسم المستخدم">
            </div>
            <div class="form-group">
                <label for="profileStatus" class="form-label">الحالة</label>
                <input type="text" id="profileStatus" class="form-input" placeholder="الحالة الجديدة">
            </div>
            <div class="form-group">
                <label for="messageBackgroundColor" class="form-label">لون خلفية الرسالة</label>
                <select id="messageBackgroundColor" class="form-input">
                    <option value="1">أزرق داكن</option>
                    <option value="2">أخضر داكن</option>
                    <option value="3">بنفسجي داكن</option>
                    <option value="4">رمادي داكن</option>
                    <option value="5">أحمر داكن</option>
                </select>
            </div>
            <div class="form-group">
                <label for="messageTextColor" class="form-label">لون نص الرسالة</label>
                <select id="messageTextColor" class="form-input">
                    <option value="1">أبيض ناعم</option>
                    <option value="2">ذهبي فاتح</option>
                    <option value="3">أزرق فاتح</option>
                    <option value="4">وردي فاتح</option>
                    <option value="5">أخضر فاتح</option>
                </select>
            </div>
        </div>
        <div class="profile-actions">
            <button class="profile-btn cancel" onclick="hideModal('profileModal')">إلغاء</button>
            <button class="profile-btn save" onclick="updateProfile()">حفظ التغييرات</button>
        </div>
    </div>
</div>

    <!-- نافذة تغيير كلمة السر -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <button class="close-modal" onclick="hideModal('passwordModal')">×</button>
            <h2 class="modal-title">تغيير كلمة السر</h2>
            <div class="profile-form">
                <div class="form-group">
                    <label for="currentPassword" class="form-label">كلمة السر الحالية</label>
                    <div class="password-container">
                        <input type="password" id="currentPassword" class="form-input" placeholder="أدخل كلمة السر الحالية">
                        <i class="fas fa-eye toggle-password" onclick="togglePassword('currentPassword')"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="newPassword" class="form-label">كلمة السر الجديدة</label>
                    <div class="password-container">
                        <input type="password" id="newPassword" class="form-input" placeholder="كلمة السر الجديدة">
                        <i class="fas fa-eye toggle-password" onclick="togglePassword('newPassword')"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword" class="form-label">تأكيد كلمة السر الجديدة</label>
                    <div class="password-container">
                        <input type="password" id="confirmNewPassword" class="form-input" placeholder="أعد إدخال كلمة السر الجديدة">
                        <i class="fas fa-eye toggle-password" onclick="togglePassword('confirmNewPassword')"></i>
                    </div>
                </div>
            </div>
            <div class="profile-actions">
                <button class="profile-btn cancel" onclick="hideModal('passwordModal')">إلغاء</button>
                <button class="profile-btn save" onclick="changePassword()">تغيير كلمة السر</button>
            </div>
        </div>
    </div>

    <script>
// تهيئة Firebase
const firebaseConfig = {
            apiKey: "AIzaSyCB9btQEUVSXi9u609CM3FLeCc",
            authDomain: "smo-chat-588cd.firebaseapp.com",
            databaseURL: "https://smo-chat-588cd-default-rtdb.firebaseio.com",
            projectId: "smo-chat-588cd",
            storageBucket: "smo-chat-588cd.firebasestorage.app",
            messagingSenderId: "606750983896",
            appId: "1:606750983896:web:fbb6a33edf34207f40b9ad" 
        };
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const storage = firebase.storage();

let currentUser = null;
let currentUserData = null;
let messageImageFile = null;
let messagesRef = null;
let usersCache = {};
let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;
let notificationTone = 'default';

// الكلمات المحظورة
const bannedWords = [
    'احا', 'كسمك', 'تيز', 'طيزك', 'امك', 'ابوك', 'كس اختك', 'متناكه',
    'عاهره', 'نيك', 'شرموطه', 'فشخ', 'xxx', 'porn', 'سكس', 'كس', 'خول', 'متناك'
];

// نغمات الإشعار
const notificationTones = {
    default: 'https://www.soundjay.com/buttons/beep-01a.mp3',
    beep: 'https://www.soundjay.com/buttons/beep-07.mp3',
    ding: 'https://www.soundjay.com/buttons/ding-01.mp3'
};

window.onload = function() {
    checkAuthState();
    setupEventListeners();
    requestNotificationPermission();
    loadTheme();
};

function requestNotificationPermission() {
    if (Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'denied') {
                showToast('تم رفض إذن الإشعارات. يمكنك تفعيلها من إعدادات المتصفح.', 'error');
            } else if (permission === 'granted') {
                showToast('تم تفعيل الإشعارات بنجاح');
            }
        });
    } else if (Notification.permission === 'denied') {
        showToast('الإشعارات معطلة. يرجى تفعيلها من إعدادات المتصفح.', 'error');
    }
}

function checkAuthState() {
    const savedUser = localStorage.getItem('chatZoonUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showPage('chatPage');
        loadUserData(currentUser.id);
        initChat();
    } else {
        showPage('loginPage');
    }
}

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
}

function setupEventListeners() {
    document.getElementById('loginPassword').addEventListener('keypress', e => {
        if (e.key === 'Enter') login();
    });
    document.getElementById('regConfirmPassword').addEventListener('keypress', e => {
        if (e.key === 'Enter') register();
    });
    document.getElementById('messageInput').addEventListener('keypress', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    document.getElementById('messageInput').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        updateTypingStatus();
    });
    document.getElementById('messageInput').addEventListener('blur', () => {
        if (currentUser) database.ref(`typing/${currentUser.id}`).remove();
    });
    window.addEventListener('click', event => {
        const modals = ['termsModal', 'registerModal', 'settingsModal', 'profileModal', 'passwordModal'];
        modals.forEach(modalId => {
            if (event.target === document.getElementById(modalId)) hideModal(modalId);
        });
    });
    window.addEventListener('online', () => showToast('تم استعادة الاتصال بالإنترنت'));
    window.addEventListener('offline', () => showToast('لا يوجد اتصال بالإنترنت', 'error'));
}

function loadTheme() {
    const theme = localStorage.getItem('theme') || 'dark';
    document.body.classList.toggle('light-mode', theme === 'light');
    const themeToggle = document.querySelector('.theme-toggle i');
    if (themeToggle) {
        themeToggle.classList.replace(theme === 'light' ? 'fa-moon' : 'fa-sun', theme === 'light' ? 'fa-sun' : 'fa-moon');
    }
}

function toggleTheme() {
    const isLight = document.body.classList.toggle('light-mode');
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    const themeToggle = document.querySelector('.theme-toggle i');
    if (themeToggle) {
        themeToggle.classList.replace(isLight ? 'fa-moon' : 'fa-sun', isLight ? 'fa-sun' : 'fa-moon');
    }
}

function loadUserData(userId) {
    database.ref('users/' + userId).on('value', snapshot => {
        currentUserData = snapshot.val();
        if (currentUserData) {
            currentUser.username = currentUserData.username;
            currentUser.status = currentUserData.status || '';
            currentUser.profileImage = currentUserData.profileImage || '';
            currentUser.notificationsEnabled = currentUserData.notificationsEnabled !== false;
            currentUser.notificationTone = currentUserData.notificationTone || 'default';
            currentUser.messageBackgroundColor = currentUserData.messageBackgroundColor || '1';
            currentUser.messageTextColor = currentUserData.messageTextColor || '1';
            localStorage.setItem('chatZoonUser', JSON.stringify(currentUser));
            updateProfileImage(currentUser.profileImage);
            updateSettingsUI();
            updateMessagesStyle();
        }
    });
}

function updateProfileImage(imageUrl) {
    const defaultImage = 'https://f.top4top.io/p_3410530mv1.jpg';
    const profileImage = imageUrl || defaultImage;

    // تحديث الصورة في رأس الدردشة
    const currentProfileImage = document.getElementById('currentProfileImage');
    if (currentProfileImage) currentProfileImage.src = profileImage;

    // تحديث الصورة في نافذة الإعدادات
    const settingsProfileImage = document.getElementById('settingsProfileImage');
    if (settingsProfileImage) settingsProfileImage.src = profileImage;

    // تحديث الصورة في معاينة الملف الشخصي
    const profileImagePreview = document.getElementById('profileImagePreview');
    if (profileImagePreview) profileImagePreview.src = profileImage;

    // تحديث صور المستخدم في جميع الرسائل
    document.querySelectorAll(`.message-user-img[data-user-id="${currentUser.id}"]`).forEach(img => {
        img.src = profileImage;
    });
}

function initChat() {
    messagesRef = database.ref('messages').limitToLast(100);
    messagesRef.on('child_added', snapshot => {
        const message = snapshot.val();
        displayMessage(message, snapshot.key);
        if (message.userId !== currentUser.id && currentUser.notificationsEnabled) {
            showNotification(message);
        }
    });
    messagesRef.on('child_changed', snapshot => {
        const message = snapshot.val();
        if (message.deleted) {
            const messageElement = document.querySelector(`[data-message-id="${snapshot.key}"]`);
            if (messageElement) messageElement.remove();
        } else {
            displayMessage(message, snapshot.key);
        }
    });
    database.ref('typing').on('value', snapshot => {
        const typingUsers = snapshot.val();
        updateTypingIndicator(typingUsers);
    });

    // تحديث بيانات المستخدمين في الوقت الفعلي
    database.ref('users').on('value', snapshot => {
        usersCache = snapshot.val() || {};
        // تحديث أسماء المستخدمين وصورهم في الرسائل
        Object.keys(usersCache).forEach(userId => {
            const user = usersCache[userId];
            const username = user.username || 'مستخدم مجهول';
            const profileImage = user.profileImage || 'https://f.top4top.io/p_3410530mv1.jpg';
            // تحديث اسم المستخدم
            document.querySelectorAll(`.message-user-name[data-user-id="${userId}"]`).forEach(name => {
                name.textContent = username;
            });
            // تحديث صورة المستخدم
            document.querySelectorAll(`.message-user-img[data-user-id="${userId}"]`).forEach(img => {
                img.src = profileImage;
            });
        });
    });

    window.addEventListener('beforeunload', () => {
        if (currentUser) {
            database.ref('users/' + currentUser.id).update({
                isOnline: false,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            database.ref(`typing/${currentUser.id}`).remove();
        }
    });
}

function updateTypingStatus() {
    if (!currentUser) return;
    const messageInput = document.getElementById('messageInput').value.trim();
    if (messageInput) {
        database.ref(`typing/${currentUser.id}`).set({
            username: currentUser.username,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    } else {
        database.ref(`typing/${currentUser.id}`).remove();
    }
}

function updateTypingIndicator(typingUsers) {
    const typingIndicator = document.getElementById('typingIndicator');
    if (!typingUsers || Object.keys(typingUsers).length === 0) {
        typingIndicator.style.display = 'none';
        return;
    }
    const typingUserIds = Object.keys(typingUsers).filter(id => id !== currentUser.id);
    if (typingUserIds.length === 0) {
        typingIndicator.style.display = 'none';
        return;
    }
    const typingUsernames = typingUserIds.map(id => typingUsers[id].username).join(', ');
    typingIndicator.textContent = `${typingUsernames} يكتب...`;
    typingIndicator.style.display = 'block';
}

function showNotification(message) {
    if (Notification.permission !== 'granted' || !document.hidden) return;
    const user = usersCache[message.userId] || { username: 'مستخدم مجهول', profileImage: 'https://f.top4top.io/p_3410530mv1.jpg' };
    new Notification(`رسالة جديدة من ${user.username}`, {
        body: message.text || (message.imageUrl ? 'تم إرسال صورة' : 'تم إرسال رسالة صوتية'),
        icon: user.profileImage,
        silent: false
    });
    playNotificationSound();
}

function playNotificationSound() {
    const audio = new Audio(notificationTones[notificationTone]);
    audio.play().catch(() => {});
}

function changeNotificationTone() {
    notificationTone = document.getElementById('notificationTone').value;
    if (currentUser) {
        database.ref('users/' + currentUser.id).update({
            notificationTone: notificationTone
        });
        playNotificationSound();
        showToast('تم تغيير نغمة الإشعار');
    }
}

function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    const agreeTerms = document.getElementById('agreeTerms').checked;

    document.getElementById('usernameError').style.display = 'none';
    document.getElementById('passwordError').style.display = 'none';
    document.getElementById('termsError').style.display = 'none';

    let isValid = true;

    if (!username) {
        document.getElementById('usernameError').style.display = 'block';
        isValid = false;
    }
    if (!password) {
        document.getElementById('passwordError').style.display = 'block';
        isValid = false;
    }
    if (!agreeTerms) {
        document.getElementById('termsError').style.display = 'block';
        isValid = false;
    }

    if (!isValid) return;

    showLoading();
    database.ref('users').orderByChild('username').equalTo(username).once('value')
        .then(snapshot => {
            if (!snapshot.exists()) {
                throw new Error('اسم المستخدم أو كلمة السر غير صحيحة');
            }
            const users = snapshot.val();
            const userId = Object.keys(users)[0];
            const user = users[userId];

            if (user.password !== password) {
                throw new Error('اسم المستخدم أو كلمة السر غير صحيحة');
            }

            currentUser = {
                id: userId,
                username: user.username,
                status: user.status || '',
                profileImage: user.profileImage || '',
                notificationsEnabled: user.notificationsEnabled !== false,
                notificationTone: user.notificationTone || 'default',
                messageBackgroundColor: user.messageBackgroundColor || '1',
                messageTextColor: user.messageTextColor || '1'
            };

            localStorage.setItem('chatZoonUser', JSON.stringify(currentUser));

            database.ref('users/' + userId).update({
                isOnline: true,
                lastSeen: null
            });

            showPage('chatPage');
            loadUserData(userId);
            initChat();
        })
        .catch(error => {
            document.getElementById('usernameError').textContent = error.message;
            document.getElementById('usernameError').style.display = 'block';
        })
        .finally(() => {
            hideLoading();
        });
}

function register() {
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    const confirmPassword = document.getElementById('regConfirmPassword').value.trim();

    document.getElementById('regUsernameError').style.display = 'none';
    document.getElementById('regPasswordError').style.display = 'none';
    document.getElementById('regConfirmPasswordError').style.display = 'none';

    let isValid = true;

    if (!username) {
        document.getElementById('regUsernameError').style.display = 'block';
        isValid = false;
    }
    if (!password) {
        document.getElementById('regPasswordError').style.display = 'block';
        isValid = false;
    }
    if (!confirmPassword) {
        document.getElementById('regConfirmPasswordError').style.display = 'block';
        isValid = false;
    }
    if (username.length < 3 || username.length > 20) {
        document.getElementById('regUsernameError').textContent = 'اسم المستخدم يجب أن يكون بين 3 و20 حرفاً';
        document.getElementById('regUsernameError').style.display = 'block';
        isValid = false;
    }
    if (password.length < 6) {
        document.getElementById('regPasswordError').textContent = 'كلمة السر يجب أن تكون 6 أحرف على الأقل';
        document.getElementById('regPasswordError').style.display = 'block';
        isValid = false;
    }
    if (!/[a-zA-Z]/.test(password) || !/[0-9]/.test(password)) {
        document.getElementById('regPasswordError').textContent = 'كلمة السر يجب أن تحتوي على أحرف وأرقام إنجليزية';
        document.getElementById('regPasswordError').style.display = 'block';
        isValid = false;
    }
    if (password !== confirmPassword) {
        document.getElementById('regConfirmPasswordError').textContent = 'كلمة السر غير متطابقة';
        document.getElementById('regConfirmPasswordError').style.display = 'block';
        isValid = false;
    }

    if (!isValid) return;

    showLoading();
    database.ref('users').orderByChild('username').equalTo(username).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                document.getElementById('regUsernameError').textContent = 'اسم المستخدم موجود مسبقاً';
                document.getElementById('regUsernameError').style.display = 'block';
                return;
            }

            const userId = database.ref('users').push().key;

            return database.ref('users/' + userId).set({
                username: username,
                password: password,
                status: '',
                profileImage: '',
                isOnline: true,
                joinedAt: firebase.database.ServerValue.TIMESTAMP,
                lastSeen: null,
                notificationsEnabled: true,
                notificationTone: 'default',
                messageBackgroundColor: '1',
                messageTextColor: '1'
            }).then(() => ({userId}));
        })
        .then(({userId}) => {
            currentUser = {
                id: userId,
                username: username,
                status: '',
                profileImage: '',
                notificationsEnabled: true,
                notificationTone: 'default',
                messageBackgroundColor: '1',
                messageTextColor: '1'
            };
            localStorage.setItem('chatZoonUser', JSON.stringify(currentUser));
            showPage('chatPage');
            loadUserData(userId);
            initChat();
            hideModal('registerModal');
        })
        .catch(error => {
            document.getElementById('regUsernameError').textContent = error.message;
            document.getElementById('regUsernameError').style.display = 'block';
        })
        .finally(() => {
            hideLoading();
        });
}

function sendMessage() {
    const messageText = document.getElementById('messageInput').value.trim();
    if (!messageText && !messageImageFile && !audioChunks.length) return;
    if (containsBannedWords(messageText)) {
        showToast('تحتوي الرسالة على كلمات غير مسموح بها', 'error');
        return;
    }
    showLoading();
    const uploadPromise = messageImageFile ?
        uploadFile(messageImageFile, 'message_' + Date.now() + '_' + messageImageFile.name, 'message_images') :
        Promise.resolve('');
    const audioPromise = audioChunks.length ?
        uploadAudio(audioChunks, 'audio_' + Date.now() + '.webm') :
        Promise.resolve('');
    Promise.all([uploadPromise, audioPromise])
        .then(([imageUrl, audioUrl]) => {
            console.log('Image URL:', imageUrl); // تسجيل رابط الصورة
            console.log('Audio URL:', audioUrl); // تسجيل رابط الصوت
            if (imageUrl && !imageUrl.startsWith('https://')) {
                throw new Error('رابط الصورة غير صالح');
            }
            if (audioUrl && !audioUrl.startsWith('https://')) {
                throw new Error('رابط الصوت غير صالح');
            }
            const message = {
                userId: currentUser.id,
                text: messageText,
                imageUrl: imageUrl,
                audioUrl: audioUrl,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            return database.ref('messages').push(message);
        })
        .then(() => {
            document.getElementById('messageInput').value = '';
            document.getElementById('messageInput').style.height = 'auto';
            messageImageFile = null;
            audioChunks = [];
            document.getElementById('imagePreviewContainer').style.display = 'none';
            database.ref(`typing/${currentUser.id}`).remove();
        })
        .catch(error => {
            console.error('Error sending message:', error);
            showToast('حدث خطأ أثناء إرسال الرسالة: ' + error.message, 'error');
        })
        .finally(() => {
            hideLoading();
        });
}

function displayMessage(message, messageId) {
    if (message.deleted) return;
    const messagesContainer = document.getElementById('messagesContainer');
    const isCurrentUser = message.userId === currentUser.id;
    const existingMessage = document.querySelector(`[data-message-id="${messageId}"]`);
    if (existingMessage) {
        existingMessage.innerHTML = createMessageContent(message, messageId, isCurrentUser);
        return;
    }
    const messageElement = document.createElement('div');
    messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
    messageElement.dataset.messageId = messageId;
    messageElement.dataset.userId = message.userId;
    messageElement.innerHTML = createMessageContent(message, messageId, isCurrentUser);

    // معالجة أخطاء تحميل الصور
    const image = messageElement.querySelector('.message-image');
    if (image) {
        image.onerror = () => {
            image.src = 'https://via.placeholder.com/150?text=Error+Loading+Image';
            showToast('فشل تحميل الصورة', 'error');
        };
    }

    // معالجة أخطاء تحميل الصوت
    const audio = messageElement.querySelector('.message-audio');
    if (audio) {
        audio.onerror = () => {
            showToast('فشل تحميل الصوتية', 'error');
        };
    }

    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function createMessageContent(message, messageId, isCurrentUser) {
    const userData = usersCache[message.userId] || {};
    const profileImage = userData.profileImage || 'https://f.top4top.io/p_3410530mv1.jpg';
    const username = userData.username || 'مستخدم مجهول';
    let messageContent = `
        <div class="message-user">
            <img src="${profileImage}" class="message-user-img" data-user-id="${message.userId}">
            <div class="message-user-name" data-user-id="${message.userId}">${username}</div>
        </div>
    `;
    if (isCurrentUser) {
        messageContent += `
            <div class="message-actions">
                <button class="delete-message-btn" onclick="deleteMessage('${messageId}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    }
    if (message.text) {
        messageContent += `<div class="message-text">${message.text}</div>`;
    }
    if (message.imageUrl) {
        messageContent += `<img src="${message.imageUrl}" class="message-image" onclick="viewImage('${message.imageUrl}')">`;
    }
    if (message.audioUrl) {
        messageContent += `<audio src="${message.audioUrl}" controls class="message-audio"></audio>`;
    }
    messageContent += `<div class="message-time">${formatTime(message.timestamp)}</div>`;
    return messageContent;
}

function deleteMessage(messageId) {
    if (confirm('هل أنت متأكد من حذف هذه الرسالة؟')) {
        showLoading();
        database.ref('messages/' + messageId).update({
            deleted: true,
            deletedAt: firebase.database.ServerValue.TIMESTAMP
        })
        .then(() => {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) messageElement.remove();
        })
        .catch(error => {
            showToast('حدث خطأ أثناء حذف الرسالة', 'error');
        })
        .finally(() => {
            hideLoading();
        });
    }
}

function handleImageUpload() {
    const fileInput = document.getElementById('messageImage');
    const file = fileInput.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
        showToast('يرجى اختيار ملف صورة صالح', 'error');
        return;
    }
    if (file.size > 5 * 1024 * 1024) {
        showToast('حجم الصورة كبير جدًا (الحد الأقصى 5MB)', 'error');
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('imagePreview').src = e.target.result;
        document.getElementById('imagePreviewContainer').style.display = 'block';
        messageImageFile = file;
    };
    reader.readAsDataURL(file);
    fileInput.value = '';
}

function removeImagePreview() {
    document.getElementById('imagePreviewContainer').style.display = 'none';
    messageImageFile = null;
}

function toggleRecording() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast('التسجيل الصوتي غير مدعوم في هذا المتصفح', 'error');
        return;
    }
    if (!isRecording) {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp3';
                mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
                audioChunks = [];
                mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) audioChunks.push(e.data);
                };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    audioChunks = [audioBlob];
                    stream.getTracks().forEach(track => track.stop());
                };
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('audioBtn').classList.add('recording');
                document.getElementById('recordingIndicator').style.display = 'block';
                setTimeout(() => {
                    if (isRecording) toggleRecording();
                }, 30000);
            })
            .catch(error => {
                console.error('Microphone access error:', error);
                showToast('فشل الوصول إلى الميكروفون: ' + error.message, 'error');
            });
    } else {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        isRecording = false;
        document.getElementById('audioBtn').classList.remove('recording');
        document.getElementById('recordingIndicator').style.display = 'none';
    }
}

function uploadFile(file, fileName, folder) {
    return new Promise((resolve, reject) => {
        if (!file) {
            resolve('');
            return;
        }
        const storageRef = storage.ref(`${folder}/${fileName}`);
        const uploadTask = storageRef.put(file);
        uploadTask.on('state_changed',
            null,
            error => {
                console.error('Upload error:', error);
                reject('حدث خطأ أثناء رفع الملف: ' + error.message);
            },
            () => {
                uploadTask.snapshot.ref.getDownloadURL().then(url => {
                    console.log('File uploaded successfully:', url);
                    resolve(url);
                }).catch(error => {
                    console.error('Error getting download URL:', error);
                    reject('فشل الحصول على رابط التحميل: ' + error.message);
                });
            }
        );
    });
}

function uploadAudio(chunks, fileName) {
    return new Promise((resolve, reject) => {
        if (!chunks.length) {
            resolve('');
            return;
        }
        const audioBlob = chunks[0];
        const storageRef = storage.ref(`audio_messages/${fileName}`);
        const uploadTask = storageRef.put(audioBlob);
        uploadTask.on('state_changed',
            null,
            error => {
                console.error('Audio upload error:', error);
                reject('حدث خطأ أثناء رفع التسجيل الصوتي: ' + error.message);
            },
            () => {
                uploadTask.snapshot.ref.getDownloadURL().then(url => {
                    console.log('Audio uploaded successfully:', url);
                    resolve(url);
                }).catch(error => {
                    console.error('Error getting audio download URL:', error);
                    reject('فشل الحصول على رابط الصوت: ' + error.message);
                });
            }
        );
    });
}

function updateProfile() {
    const newUsername = document.getElementById('profileUsername').value.trim();
    const newStatus = document.getElementById('profileStatus').value.trim();
    const messageBackgroundColor = document.getElementById('messageBackgroundColor').value;
    const messageTextColor = document.getElementById('messageTextColor').value;

    if (!newUsername) {
        showToast('اسم المستخدم مطلوب', 'error');
        return;
    }
    if (messageBackgroundColor === messageTextColor) {
        showToast('لا يمكن اختيار نفس اللون للخلفية والنص', 'error');
        return;
    }

    showLoading();
    database.ref('users/' + currentUser.id).update({
        username: newUsername,
        status: newStatus,
        messageBackgroundColor: messageBackgroundColor,
        messageTextColor: messageTextColor
    })
    .then(() => {
        currentUser.username = newUsername;
        currentUser.status = newStatus;
        currentUser.messageBackgroundColor = messageBackgroundColor;
        currentUser.messageTextColor = messageTextColor;
        localStorage.setItem('chatZoonUser', JSON.stringify(currentUser));
        updateSettingsUI();
        updateMessagesStyle();
        // تحديث اسم المستخدم في الرسائل
        document.querySelectorAll(`.message-user-name[data-user-id="${currentUser.id}"]`).forEach(name => {
            name.textContent = newUsername;
        });
        showToast('تم تحديث الملف الشخصي بنجاح');
        setTimeout(() => hideModal('profileModal'), 1000);
    })
    .catch(error => {
        showToast('حدث خطأ أثناء تحديث الملف الشخصي: ' + error.message, 'error');
    })
    .finally(() => {
        hideLoading();
    });
}

function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value.trim();
    const newPassword = document.getElementById('newPassword').value.trim();
    const confirmNewPassword = document.getElementById('confirmNewPassword').value.trim();
    if (!currentPassword || !newPassword || !confirmNewPassword) {
        showToast('الرجاء ملء جميع الحقول', 'error');
        return;
    }
    if (currentUserData.password !== currentPassword) {
        showToast('كلمة السر الحالية غير صحيحة', 'error');
        return;
    }
    if (newPassword.length < 6) {
        showToast('كلمة السر يجب أن تكون 6 أحرف على الأقل', 'error');
        return;
    }
    if (!/[a-zA-Z]/.test(newPassword) || !/[0-9]/.test(newPassword)) {
        showToast('كلمة السر يجب أن تحتوي على أحرف وأرقام إنجليزية', 'error');
        return;
    }
    if (newPassword !== confirmNewPassword) {
        showToast('كلمة السر الجديدة غير متطابقة', 'error');
        return;
    }
    showLoading();
    database.ref('users/' + currentUser.id).update({
        password: newPassword
    })
    .then(() => {
        showToast('تم تغيير كلمة السر بنجاح');
        hideModal('passwordModal');
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
    })
    .catch(error => {
        showToast('حدث خطأ أثناء تغيير كلمة السر', 'error');
    })
    .finally(() => {
        hideLoading();
    });
}

function logout() {
    if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
        if (currentUser) {
            database.ref('users/' + currentUser.id).update({
                isOnline: false,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            });
            database.ref(`typing/${currentUser.id}`).remove();
        }
        localStorage.removeItem('chatZoonUser');
        currentUser = null;
        currentUserData = null;
        if (messagesRef) messagesRef.off();
        showPage('loginPage');
        clearInputs();
    }
}

function toggleNotifications() {
    const isEnabled = document.getElementById('notificationsToggle').checked;
    currentUser.notificationsEnabled = isEnabled;
    localStorage.setItem('chatZoonUser', JSON.stringify(currentUser));
    database.ref('users/' + currentUser.id).update({
        notificationsEnabled: isEnabled
    })
    .then(() => {
        showToast(`تم ${isEnabled ? 'تفعيل' : 'تعطيل'} الإشعارات`);
    })
    .catch(error => {
        showToast('حدث خطأ أثناء تحديث إعدادات الإشعارات', 'error');
    });
}

async function handleProfileImageUpload(file) {
    if (!file) {
        showToast('لم يتم اختيار صورة', 'error');
        return;
    }
    if (!file.type.startsWith('image/')) {
        showToast('يرجى اختيار ملف صورة صالح (مثل JPG أو PNG)', 'error');
        return;
    }
    if (file.size > 5 * 1024 * 1024) {
        showToast('حجم الصورة كبير جدًا (الحد الأقصى 5 ميجابايت)', 'error');
        return;
    }

    const loadingElement = document.getElementById('profileLoading');
    const userId = currentUser.id;
    loadingElement.style.display = 'block';

    try {
        // عرض معاينة الصورة محليًا
        const reader = new FileReader();
        reader.onload = function(e) {
            const profileImagePreview = document.getElementById('profileImagePreview');
            if (profileImagePreview) {
                profileImagePreview.src = e.target.result;
            }
        };
        reader.readAsDataURL(file);

        // حذف الصورة القديمة إذا لم تكن الصورة الافتراضية
        if (currentUser.profileImage && currentUser.profileImage !== 'https://f.top4top.io/p_3410530mv1.jpg') {
            try {
                await storage.refFromURL(currentUser.profileImage).delete();
                console.log('Old profile image deleted');
            } catch (error) {
                console.warn('Failed to delete old profile image:', error.message);
            }
        }

        // رفع الصورة الجديدة
        const fileName = `profile_${userId}_${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
        const newImageRef = storage.ref(`profile_images/${userId}/${fileName}`);
        const snapshot = await newImageRef.put(file);
        const downloadURL = await snapshot.ref.getDownloadURL();
        console.log('Profile image uploaded:', downloadURL);

        // تحديث قاعدة البيانات
        await database.ref(`users/${userId}`).update({
            profileImage: downloadURL
        });

        // تحديث بيانات المستخدم المحلية
        currentUser.profileImage = downloadURL;
        localStorage.setItem('chatZoonUser', JSON.stringify(currentUser));

        // تحديث واجهة المستخدم
        updateProfileImage(downloadURL);

        // تحديث صور المستخدم في الرسائل
        document.querySelectorAll(`.message-user-img[data-user-id="${userId}"]`).forEach(img => {
            img.src = downloadURL;
        });

        showToast('تم تحديث الصورة الشخصية بنجاح');
    } catch (error) {
        console.error('Error uploading profile image:', error);
        let errorMessage = 'حدث خطأ أثناء رفع الصورة';
        if (error.code === 'storage/unauthorized') {
            errorMessage = 'غير مصرح لك برفع الصور. تحقق من إعدادات Firebase Storage.';
        } else if (error.code === 'storage/canceled') {
            errorMessage = 'تم إلغاء رفع الصورة.';
        } else if (error.code === 'storage/unknown') {
            errorMessage = 'خطأ غير معروف. تحقق من اتصال الإنترنت.';
        }
        showToast(errorMessage, 'error');
    } finally {
        loadingElement.style.display = 'none';
    }
}
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling;
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
    }
}

function updateSettingsUI() {
    const defaultImage = 'https://f.top4top.io/p_3410530mv1.jpg';
    document.getElementById('settingsProfileImage').src = currentUser.profileImage || defaultImage;
    document.getElementById('profileImagePreview').src = currentUser.profileImage || defaultImage;
    document.getElementById('settingsUsername').textContent = currentUser.username || '';
    document.getElementById('settingsStatus').textContent = currentUser.status || 'لا توجد حالة';
    document.getElementById('profileUsername').value = currentUser.username || '';
    document.getElementById('profileStatus').value = currentUser.status || '';
    document.getElementById('messageBackgroundColor').value = currentUser.messageBackgroundColor || '1';
    document.getElementById('messageTextColor').value = currentUser.messageTextColor || '1';
    document.getElementById('notificationsToggle').checked = currentUser.notificationsEnabled;
    document.getElementById('notificationTone').value = notificationTone || 'default';
}

function updateMessagesStyle() {
    const styleElement = document.getElementById('custom-message-style') || document.createElement('style');
    styleElement.id = 'custom-message-style';
    const css = `
        .message.sent[data-user-id="${currentUser.id}"] {
            background: var(--message-bg-${currentUser.messageBackgroundColor}, var(--message-sent)) !important;
            color: var(--message-text-${currentUser.messageTextColor}, var(--light)) !important;
        }
        .message.sent[data-user-id="${currentUser.id}"] .message-text,
        .message.sent[data-user-id="${currentUser.id}"] .message-user-name,
        .message.sent[data-user-id="${currentUser.id}"] .message-time {
            color: inherit !important;
        }
    `;
    styleElement.textContent = css;
    document.head.appendChild(styleElement);
    const messagesContainer = document.getElementById('messagesContainer');
    messagesContainer.querySelectorAll('.message.sent[data-user-id="' + currentUser.id + '"]').forEach(message => {
        message.style.background = `var(--message-bg-${currentUser.messageBackgroundColor})`;
        message.style.color = `var(--message-text-${currentUser.messageTextColor})`;
    });
}

function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    let hours = date.getHours();
    let minutes = date.getMinutes().toString().padStart(2, '0');
    let period = hours >= 12 ? 'مساءً' : 'صباحًا';
    let hour12 = hours % 12 || 12;
    return `${hour12}:${minutes} ${period}`;
}

function containsBannedWords(text) {
    if (!text) return false;
    const lowerText = text.toLowerCase();
    return bannedWords.some(word => lowerText.includes(word.toLowerCase()));
}

function viewImage(imageUrl) {
    window.open(imageUrl, '_blank');
}

function searchMessages() {
    const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
    const messages = document.querySelectorAll('.message');
    messages.forEach(message => {
        const text = message.querySelector('.message-text');
        if (!text || !searchTerm) {
            message.style.display = '';
            return;
        }
        const textContent = text.textContent.toLowerCase();
        message.style.display = textContent.includes(searchTerm) ? '' : 'none';
    });
}

function showModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
    if (modalId === 'settingsModal' || modalId === 'profileModal') updateSettingsUI();
}

function hideModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    clearInputs();
}

function clearInputs() {
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('regUsername').value = '';
    document.getElementById('regPassword').value = '';
    document.getElementById('regConfirmPassword').value = '';
    document.getElementById('agreeTerms').checked = false;
    document.getElementById('profileUsername').value = currentUser ? currentUser.username : '';
    document.getElementById('profileStatus').value = currentUser ? currentUser.status || '' : '';
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmNewPassword').value = '';
    document.getElementById('usernameError').style.display = 'none';
    document.getElementById('passwordError').style.display = 'none';
    document.getElementById('termsError').style.display = 'none';
    document.getElementById('regUsernameError').style.display = 'none';
    document.getElementById('regPasswordError').style.display = 'none';
    document.getElementById('regConfirmPasswordError').style.display = 'none';
}

function showLoading() {
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type === 'error' ? 'error' : ''}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000); // زيادة مدة العرض لقراءة الرسالة
}


function updateProfileImage(imageUrl) {
    const defaultImage = 'https://f.top4top.io/p_3410530mv1.jpg';
    const profileImage = imageUrl || defaultImage;

    // تحديث الصورة في رأس الدردشة
    const currentProfileImage = document.getElementById('currentProfileImage');
    if (currentProfileImage) currentProfileImage.src = profileImage;

    // تحديث الصورة في نافذة الإعدادات
    const settingsProfileImage = document.getElementById('settingsProfileImage');
    if (settingsProfileImage) settingsProfileImage.src = profileImage;

    // تحديث الصورة في معاينة الملف الشخصي
    const profileImagePreview = document.getElementById('profileImagePreview');
    if (profileImagePreview) profileImagePreview.src = profileImage;

    // تحديث صور المستخدم في جميع الرسائل
    document.querySelectorAll(`.message-user-img[data-user-id="${currentUser.id}"]`).forEach(img => {
        img.src = profileImage;
    });
}
    </script>
</body>
</html>